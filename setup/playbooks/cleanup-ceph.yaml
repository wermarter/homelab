- name: Cleanup Ceph disks and data
  hosts: all
  become: true
  vars:
    ceph_disk: /dev/sda
    ceph_partition: /dev/sda3
    ceph_partition_num: 3
    ceph_start: 30GiB
    rook_data_dir: /var/lib/rook

  tasks:
    - name: Disconnect and remove nbd devices
      ansible.builtin.shell: |
        # Disconnect any active nbd devices
        for dev in /dev/nbd[0-9]*; do
          if [ -b "$dev" ]; then
            qemu-nbd -d "$dev" || true
          fi
        done
        # Unload the nbd module to remove them from lsblk
        modprobe -r nbd
      failed_when: false
      changed_when: true

    - name: Remove Rook data directory
      ansible.builtin.file:
        path: "{{ rook_data_dir }}"
        state: absent

    - name: Check if Ceph partition exists
      ansible.builtin.stat:
        path: "{{ ceph_partition }}"
      register: ceph_part_stat

    - name: Cleanup and Recreate Ceph partition
      block:
        - name: Wipe and Delete if partition exists
          when: ceph_part_stat.stat.exists
          block:
            - name: Wipe filesystem signatures on Ceph partition
              ansible.builtin.command: wipefs -a {{ ceph_partition }}
              failed_when: false

            - name: Zap the Ceph partition beginning with dd
              ansible.builtin.command: dd if=/dev/zero of={{ ceph_partition }} bs=1M count=100 oflag=direct,dsync
              failed_when: false

            - name: Delete the partition
              ansible.builtin.command: parted {{ ceph_disk }} rm {{ ceph_partition_num }}
              failed_when: false

        - name: Recreate Ceph partition
          ansible.builtin.shell: |
            # Recreate the partition starting at {{ ceph_start }} (matching prepare-ceph.yaml)
            echo "Yes" | parted {{ ceph_disk }} ---pretend-input-tty mkpart primary {{ ceph_start }} 100%

            # Inform kernel and sync
            partprobe {{ ceph_disk }}
            udevadm settle
          args:
            executable: /bin/bash
          changed_when: true

    - name: Final check of partition layout
      ansible.builtin.command: lsblk
      register: lsblk_final
      changed_when: false

    - name: Display final partition layout
      ansible.builtin.debug:
        var: lsblk_final.stdout_lines
